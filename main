#!/usr/bin/env bash

# Copyright (c) 2025 Smokeyk00
# Author: Smokeyk00
# License: MIT | https://github.com/Smokeyk00
# Source: https://creality.com/

# === Funktionsdeklaration ===
source /dev/stdin <<<"$FUNCTIONS_FILE_PATH"
color
verb_ip6
catch_errors
setting_up_container
network_check
update_os

# === Installera nödvändiga beroenden ===
msg_info "Installerar beroenden för Creality Print"
$STD apt-get install -y git \
  libyaml-dev \
  build-essential \
  curl \
  wget \
  sudo
msg_ok "Installerade beroenden"

# === Installera Creality Print ===
msg_info "Installerar Creality Print"
$STD sudo -u creality bash <<EOF
curl -sSL https://crealityprint-installers.creality.com/crealityprint-installer.sh | bash
EOF
msg_ok "Installerade Creality Print"

# === Skapa användare för Creality Print ===
msg_info "Skapar användare för Creality Print"
useradd -m -s /bin/bash -p $(openssl passwd -1 creality) creality
usermod -aG sudo,tty,dialout creality
chown -R creality:creality /opt
echo "creality ALL=NOPASSWD: $(command -v systemctl) restart crealityprint, $(command -v reboot), $(command -v poweroff)" >/etc/sudoers.d/creality
msg_ok "Skapade användare för Creality Print"

# === Installera Creality Cloud Integration ===
msg_info "Installerar Creality Cloud Integration"
$STD sudo -u creality bash <<EOF
curl -sSL https://cloud.creality.com/installer.sh | bash
EOF
msg_ok "Installerade Creality Cloud Integration"

# === Skapa systemd service för Creality Print ===
msg_info "Skapar systemd-tjänst för Creality Print"
cat <<EOF >/etc/systemd/system/crealityprint.service
[Unit]
Description=Creality Print Web Interface
After=network-online.target
Wants=network-online.target

[Service]
Environment="LC_ALL=C.UTF-8"
Environment="LANG=C.UTF-8"
Type=exec
User=creality
ExecStart=/opt/crealityprint/bin/crealityprint serve

[Install]
WantedBy=multi-user.target
EOF
systemctl enable -q --now crealityprint
msg_ok "Skapade systemd-tjänst för Creality Print"

# === Installera och konfigurera NGINX för webbadressåtkomst ===
msg_info "Installerar och konfigurerar NGINX"
$STD apt-get install -y nginx
systemctl enable nginx
systemctl start nginx
msg_ok "Installerade och startade NGINX"

# === Rensa upp efter installation ===
msg_info "Rensar upp efter installation"
$STD apt-get -y autoremove
$STD apt-get -y autoclean
msg_ok "Rensat upp"

# === Bekräftelse ===
msg_info "Creality Print installation klar!"
msg_info "Åtkomst till Creality Print via webbläsaren på http://<din-server-ip>:80"

